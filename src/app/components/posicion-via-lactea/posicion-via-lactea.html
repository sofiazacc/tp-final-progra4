<div class="container-principal">

  <div class="acciones-superiores">
    <div class="titulo-wrapper">
      <h2>Calculadora de la Vía Láctea</h2>
      
      <div class="tooltip-container">
        <span class="material-symbols-outlined icono-info">info</span>
        
        <div class="tooltip-texto">
          <strong>¿Para qué sirve esto?</strong>
          <p>Esta herramienta ayuda a planificar fotografías nocturnas. Calcula dónde estará el centro de la galaxia en el cielo para saber hacia dónde apuntar la cámara y a qué hora será visible.</p>
        </div>
      </div>

    </div>
  </div>
  <form [formGroup]="formulario" class="formulario-container">

    <div class="fila-ubicacion">
      <button type="button" (click)="usarUbicacionActual()" class="btn-ghost">
        <span class="material-symbols-outlined">my_location</span> Usar mi ubicación actual
      </button>
    </div>

    <div class="grid-inputs">
      <div class="grupo-input">
        <label>Latitud</label>
        <input 
          type="number" 
          formControlName="latitud" 
          placeholder="Ej: -38.0055"
          step="0.0001">
        <small>Rango: -90 a 90</small>
      </div>

      <div class="grupo-input">
        <label>Longitud</label>
        <input 
          type="number" 
          formControlName="longitud" 
          placeholder="Ej: -57.5426"
          step="0.0001">
        <small>Rango: -180 a 180</small>
      </div>

      <div class="grupo-input">
        <label>Fecha</label>
        <input type="date" formControlName="fecha">
      </div>

      <div class="grupo-input">
        <label>Hora</label>
        <input type="time" formControlName="hora">
      </div>
    </div>

    <div class="botones-accion">
      <button 
        type="button" 
        (click)="calcularPosicionActual()"
        [disabled]="formulario.invalid"
        class="btn-calcular principal">
        Calcular Ahora
      </button>

      <button 
        type="button" 
        (click)="analizarDiaCompleto()"
        [disabled]="formulario.invalid"
        class="btn-calcular secundario">
        Analizar Día Completo
      </button>
    </div>

  </form>

  @if(posicionActual && !mostrarAnalisisDia) {
    <div class="resultado-container">
      <h3 class="resultado-titulo">Posición del Centro Galáctico</h3>
      
      <div class="grilla-resultados">
        <div class="resultado-item">
          <span class="label">Azimut</span>
          <span class="valor">{{ posicionActual.azimut }}°</span>
          <span class="sub-valor">{{ posicionActual.direccionCardinal }}</span>
        </div>

        <div class="resultado-item">
          <span class="label">Altitud</span>
          <span class="valor">{{ posicionActual.altitud }}°</span>
        </div>

        <div class="resultado-item" [class.visible-box]="posicionActual.visible" [class.oculto-box]="!posicionActual.visible">
          <span class="label">Visibilidad</span>
          <span class="valor-texto">{{ posicionActual.visible ? 'VISIBLE' : 'NO VISIBLE' }}</span>
        </div>
      </div>

      <div class="evaluacion-box">
        <p>{{ obtenerEvaluacion(posicionActual) }}</p>
      </div>

      <div class="info-extra">
        <p><strong>Referencia:</strong> Azimut 0°=Norte, 180°=Sur | Altitud 90°=Cenit</p>
      </div>
    </div>
  }

  @if(mostrarAnalisisDia) {
    <div class="resultado-container">
      <h3 class="resultado-titulo">Análisis del Día Completo</h3>

      @if(mejorMomento) {
        <div class="mejor-momento-card">
          <h4><span class="material-symbols-outlined">star</span> Mejor Momento (Noche)</h4>
          <div class="momento-grid">
            <div>
              <span class="m-label">Hora</span>
              <span class="m-valor">{{ mejorMomento.horaCalculo | date:'HH:mm' }}</span>
            </div>
            <div>
              <span class="m-label">Azimut</span>
              <span class="m-valor">{{ mejorMomento.azimut }}°</span>
            </div>
            <div>
              <span class="m-label">Altitud</span>
              <span class="m-valor">{{ mejorMomento.altitud }}°</span>
            </div>
          </div>
          <p class="m-evaluacion">{{ obtenerEvaluacion(mejorMomento) }}</p>
        </div>
      } @else {
        <div class="alerta-info">
          <p>La Vía Láctea no es visible durante la noche en esta fecha.</p>
        </div>
      }

      <div class="tabla-wrapper">
        <table class="tabla-moderna">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Azimut</th>
              <th>Altitud</th>
              <th>Visible</th>
              <th>Noche</th>
            </tr>
          </thead>
          <tbody>
            @for(pos of posicionesDia; track pos.horaCalculo) {
              <tr 
                [class.destacado]="pos.altitud > 30 && pos.esDeNoche" 
                [class.dia]="!pos.esDeNoche">
                <td><strong>{{ pos.horaCalculo | date:'HH:mm' }}</strong></td>
                <td>{{ pos.azimut }}° <small>{{ pos.direccionCardinal }}</small></td>
                <td>{{ pos.altitud }}°</td>
                <td>
                  <span class="badge" [class.si]="pos.visible" [class.no]="!pos.visible">
                    {{ pos.visible ? 'Sí' : 'No' }}
                  </span>
                </td>
                <td>{{ pos.esDeNoche ? 'Sí' : 'No' }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

</div>